const i={context:void 0,registry:void 0};function m(t){i.context=t}function R(){return{...i.context,id:`${i.context.id}${i.context.count++}-`,count:0}}const $=(t,e)=>t===e,g={equals:$};let k=T;const h=1,v=2,U={owned:null,cleanups:null,context:null,owner:null};var o=null;let E=null,u=null,c=null,a=null,x=0;function V(t,e){const s=u,n=o,r=t.length===0,l=e===void 0?n:e,f=r?U:{owned:null,cleanups:null,context:l?l.context:null,owner:l},L=r?t:()=>t(()=>p(()=>y(f)));o=f,u=null;try{return b(L,!0)}finally{u=s,o=n}}function W(t,e){e=e?Object.assign({},g,e):g;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),O(s,r));return[N.bind(s),n]}function z(t,e,s){const n=A(t,e,!1,h);w(n)}function j(t,e,s){k=I;const n=A(t,e,!1,h);(!s||!s.render)&&(n.user=!0),a?a.push(n):w(n)}function C(t,e,s){s=s?Object.assign({},g,s):g;const n=A(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,w(n),N.bind(n)}function p(t){if(u===null)return t();const e=u;u=null;try{return t()}finally{u=e}}function B(t){j(()=>p(t))}function J(t){return o===null||(o.cleanups===null?o.cleanups=[t]:o.cleanups.push(t)),t}function N(){if(this.sources&&this.state)if(this.state===h)w(this);else{const t=c;c=null,b(()=>S(this),!1),c=t}if(u){const t=this.observers?this.observers.length:0;u.sources?(u.sources.push(this),u.sourceSlots.push(t)):(u.sources=[this],u.sourceSlots=[t]),this.observers?(this.observers.push(u),this.observerSlots.push(u.sources.length-1)):(this.observers=[u],this.observerSlots=[u.sources.length-1])}return this.value}function O(t,e,s){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&b(()=>{for(let r=0;r<t.observers.length;r+=1){const l=t.observers[r],f=E&&E.running;f&&E.disposed.has(l),(f?!l.tState:!l.state)&&(l.pure?c.push(l):a.push(l),l.observers&&D(l)),f||(l.state=h)}if(c.length>1e6)throw c=[],new Error},!1)),e}function w(t){if(!t.fn)return;y(t);const e=x;M(t,t.value,e)}function M(t,e,s){let n;const r=o,l=u;u=o=t;try{n=t.fn(e)}catch(f){return t.pure&&(t.state=h,t.owned&&t.owned.forEach(y),t.owned=null),t.updatedAt=s+1,F(f)}finally{u=l,o=r}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?O(t,n):t.value=n,t.updatedAt=s)}function A(t,e,s,n=h,r){const l={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:o,context:o?o.context:null,pure:s};return o===null||o!==U&&(o.owned?o.owned.push(l):o.owned=[l]),l}function d(t){if(t.state===0)return;if(t.state===v)return S(t);if(t.suspense&&p(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<x);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===h)w(t);else if(t.state===v){const n=c;c=null,b(()=>S(t,e[0]),!1),c=n}}function b(t,e){if(c)return t();let s=!1;e||(c=[]),a?s=!0:a=[],x++;try{const n=t();return G(s),n}catch(n){s||(a=null),c=null,F(n)}}function G(t){if(c&&(T(c),c=null),t)return;const e=a;a=null,e.length&&b(()=>k(e),!1)}function T(t){for(let e=0;e<t.length;e++)d(t[e])}function I(t){let e,s=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[s++]=n:d(n)}if(i.context){if(i.count){i.effects||(i.effects=[]),i.effects.push(...t.slice(0,s));return}else i.effects&&(t=[...i.effects,...t],s+=i.effects.length,delete i.effects);m()}for(e=0;e<s;e++)d(t[e])}function S(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const n=t.sources[s];if(n.sources){const r=n.state;r===h?n!==e&&(!n.updatedAt||n.updatedAt<x)&&d(n):r===v&&S(n,e)}}}function D(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=v,s.pure?c.push(s):a.push(s),s.observers&&D(s))}}function y(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),n=t.sourceSlots.pop(),r=s.observers;if(r&&r.length){const l=r.pop(),f=s.observerSlots.pop();n<r.length&&(l.sourceSlots[f]=n,r[n]=l,s.observerSlots[n]=f)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)y(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function P(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function F(t,e=o){throw P(t)}let H=!1;function K(){H=!0}function X(t,e){if(H&&i.context){const s=i.context;m(R());const n=p(()=>t(e||{}));return m(s),n}return p(()=>t(e||{}))}const Q=t=>`Stale read from <${t}>.`;function Y(t){const e=t.keyed,s=C(()=>t.when,void 0,{equals:(n,r)=>e?n===r:!n==!r});return C(()=>{const n=s();if(n){const r=t.children;return typeof r=="function"&&r.length>0?p(()=>r(e?n:()=>{if(!p(s))throw Q("Show");return t.when})):r}return t.fallback},void 0,void 0)}export{Y as S,X as a,z as b,W as c,V as d,K as e,J as f,B as o,i as s,p as u};
