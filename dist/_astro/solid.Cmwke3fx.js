const i={context:void 0,registry:void 0};function m(t){i.context=t}function R(){return{...i.context,id:`${i.context.id}${i.context.count++}-`,count:0}}const $=(t,e)=>t===e,g={equals:$};let k=T;const h=1,v=2,U={owned:null,cleanups:null,context:null,owner:null};var o=null;let E=null,u=null,c=null,a=null,x=0;function V(t,e){const n=u,s=o,r=t.length===0,l=e===void 0?s:e,f=r?U:{owned:null,cleanups:null,context:l?l.context:null,owner:l},L=r?t:()=>t(()=>p(()=>y(f)));o=f,u=null;try{return b(L,!0)}finally{u=n,o=s}}function W(t,e){e=e?Object.assign({},g,e):g;const n={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},s=r=>(typeof r=="function"&&(r=r(n.value)),O(n,r));return[N.bind(n),s]}function z(t,e,n){const s=A(t,e,!1,h);w(s)}function j(t,e,n){k=I;const s=A(t,e,!1,h);s.user=!0,a?a.push(s):w(s)}function C(t,e,n){n=n?Object.assign({},g,n):g;const s=A(t,e,!0,0);return s.observers=null,s.observerSlots=null,s.comparator=n.equals||void 0,w(s),N.bind(s)}function p(t){if(u===null)return t();const e=u;u=null;try{return t()}finally{u=e}}function B(t){j(()=>p(t))}function J(t){return o===null||(o.cleanups===null?o.cleanups=[t]:o.cleanups.push(t)),t}function N(){if(this.sources&&this.state)if(this.state===h)w(this);else{const t=c;c=null,b(()=>S(this),!1),c=t}if(u){const t=this.observers?this.observers.length:0;u.sources?(u.sources.push(this),u.sourceSlots.push(t)):(u.sources=[this],u.sourceSlots=[t]),this.observers?(this.observers.push(u),this.observerSlots.push(u.sources.length-1)):(this.observers=[u],this.observerSlots=[u.sources.length-1])}return this.value}function O(t,e,n){let s=t.value;return(!t.comparator||!t.comparator(s,e))&&(t.value=e,t.observers&&t.observers.length&&b(()=>{for(let r=0;r<t.observers.length;r+=1){const l=t.observers[r],f=E&&E.running;f&&E.disposed.has(l),(f?!l.tState:!l.state)&&(l.pure?c.push(l):a.push(l),l.observers&&D(l)),f||(l.state=h)}if(c.length>1e6)throw c=[],new Error},!1)),e}function w(t){if(!t.fn)return;y(t);const e=x;M(t,t.value,e)}function M(t,e,n){let s;const r=o,l=u;u=o=t;try{s=t.fn(e)}catch(f){return t.pure&&(t.state=h,t.owned&&t.owned.forEach(y),t.owned=null),t.updatedAt=n+1,F(f)}finally{u=l,o=r}(!t.updatedAt||t.updatedAt<=n)&&(t.updatedAt!=null&&"observers"in t?O(t,s):t.value=s,t.updatedAt=n)}function A(t,e,n,s=h,r){const l={fn:t,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:o,context:o?o.context:null,pure:n};return o===null||o!==U&&(o.owned?o.owned.push(l):o.owned=[l]),l}function d(t){if(t.state===0)return;if(t.state===v)return S(t);if(t.suspense&&p(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<x);)t.state&&e.push(t);for(let n=e.length-1;n>=0;n--)if(t=e[n],t.state===h)w(t);else if(t.state===v){const s=c;c=null,b(()=>S(t,e[0]),!1),c=s}}function b(t,e){if(c)return t();let n=!1;e||(c=[]),a?n=!0:a=[],x++;try{const s=t();return G(n),s}catch(s){n||(a=null),c=null,F(s)}}function G(t){if(c&&(T(c),c=null),t)return;const e=a;a=null,e.length&&b(()=>k(e),!1)}function T(t){for(let e=0;e<t.length;e++)d(t[e])}function I(t){let e,n=0;for(e=0;e<t.length;e++){const s=t[e];s.user?t[n++]=s:d(s)}if(i.context){if(i.count){i.effects||(i.effects=[]),i.effects.push(...t.slice(0,n));return}else i.effects&&(t=[...i.effects,...t],n+=i.effects.length,delete i.effects);m()}for(e=0;e<n;e++)d(t[e])}function S(t,e){t.state=0;for(let n=0;n<t.sources.length;n+=1){const s=t.sources[n];if(s.sources){const r=s.state;r===h?s!==e&&(!s.updatedAt||s.updatedAt<x)&&d(s):r===v&&S(s,e)}}}function D(t){for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];n.state||(n.state=v,n.pure?c.push(n):a.push(n),n.observers&&D(n))}}function y(t){let e;if(t.sources)for(;t.sources.length;){const n=t.sources.pop(),s=t.sourceSlots.pop(),r=n.observers;if(r&&r.length){const l=r.pop(),f=n.observerSlots.pop();s<r.length&&(l.sourceSlots[f]=s,r[s]=l,n.observerSlots[s]=f)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)y(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function P(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function F(t,e=o){throw P(t)}let H=!1;function K(){H=!0}function X(t,e){if(H&&i.context){const n=i.context;m(R());const s=p(()=>t(e||{}));return m(n),s}return p(()=>t(e||{}))}const Q=t=>`Stale read from <${t}>.`;function Y(t){const e=t.keyed,n=C(()=>t.when,void 0,{equals:(s,r)=>e?s===r:!s==!r});return C(()=>{const s=n();if(s){const r=t.children;return typeof r=="function"&&r.length>0?p(()=>r(e?s:()=>{if(!p(n))throw Q("Show");return t.when})):r}return t.fallback},void 0,void 0)}export{Y as S,X as a,z as b,W as c,V as d,K as e,J as f,B as o,i as s,p as u};
